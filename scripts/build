#!/bin/sh

. config/options

if [ -z "$1" ]; then
  echo "usage: $0 package_name"
  exit 1
fi

$SCRIPTS/unpack $1 || exit 2
if [ -f .stamps/$1/build -a -f $PACKAGES/$1/need_build ]; then
  $PACKAGES/$1/need_build $@
fi

if [ ! -f .stamps/$1/build ]; then
  rm -f .stamps/$1/build

  printf "%${INDENT}c BUILD    $1\n" >&$SILENT_OUT
  export INDENT=$((${INDENT:-1}+$INDENT_SIZE))

  if [ -f $PACKAGES/$1/build ]; then
    $PACKAGES/$1/build $@ >&$VERBOSE_OUT || exit 3
  elif [ -f $BUILD/$1*/Makefile ]; then
    make -C $BUILD/$1* >&$VERBOSE_OUT || exit 3
  fi

  . $CONFIG/options
  for i in `sed -n "s/^\(.*\)=.*$/\1/p" $CONFIG/options`; do
    echo STAMP_$i=${!i} >> .stamps/$1/build
  done
fi
