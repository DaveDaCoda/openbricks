#!/bin/sh

. config/options

deps="gcc g++ make patch nasm tar bzip2 gzip wget mkisofs mkzftree cdrecord perl flex"
deps_pkg="gcc g++ make patch nasm tar bzip2 gzip wget mkisofs zisofs-tools cdrecord perl flex"
files="/usr/include/stdio.h"
files_pkg="libc6-dev"

deps=($deps)
deps_pkg=($deps_pkg)
nb_deps=${#deps[*]}
for ((i=0; i<$nb_deps; i++)); do
  [ -z "`which ${deps[$i]} 2>/dev/null`" ] && need="$need ${deps[$i]}" && need_pkg="$need_pkg ${deps_pkg[$i]}"
done

files=($files)
files_pkg=($files_pkg)
nb_files=${#files[*]}
for ((i=0; i<$nb_files; i++)); do
  [ ! -f ${files[$i]} ] && need="$need ${files_pkg[$i]}" && need_pkg="$need_pkg ${files_pkg[$i]}"
done

if [ -n "$need" ]; then
  echo "**** Your system lacks the following tools needed to build GeeXboX ****"
  echo $need
  if [ -f /etc/debian_version -a -n "`which apt-get 2>/dev/null`" ]; then
    echo "**** You seem to use a debian system ****"
    if [ $UID -ne 0 ]; then
      echo "**** I could install those packages but you need to be root for this ****"
      exit 1
    else
      read -p "would you like to apt-get install the needed tools ? (y/n) " ans
      need_pkg=`echo $need_pkg | sed s/zisofs-tools/mkisofs/`
      [ "$ans" = "y" ] && apt-get install $need_pkg || exit 1
    fi
  elif [ -f /etc/mandrake-release -a -n "`which urpmi 2>/dev/null`" ]; then
    echo "**** You seem to use a mandrake system ****"
    if [ $UID -ne 0 ]; then
      echo "**** I could install those packages but you need to be root for this ****"
      exit 1
    else
      read -p "would you like to urpmi the needed tools ? (y/n) " ans
      [ "$ans" = "y" ] && urpmi $need_pkg || exit 1
    fi
  else
    echo "********"
    exit 1
  fi
fi


need=""
need_pkg=""
for ((i=0; i<$nb_deps; i++)); do
  [ -z "`which ${deps[$i]} 2>/dev/null`" ] && need="$need ${deps[$i]}" && need_pkg="$need_pkg ${deps_pkg[$i]}"
done

for ((i=0; i<$nb_files; i++)); do
  [ ! -f "${files[$i]}" ] && need="$need ${files_pkg[$i]}" && need_pkg="$need_pkg ${files_pkg[$i]}"
done

if [ -n "$need" ]; then
  if [ "$need" = " mkzftree" ]; then
    echo "**** mkzftree was not installed correctly."
    echo "**** It is not included in debian woody."
    echo "**** You will need for example a sarge version of mkisofs."
  else
    echo "**** The following packages were not installed correctly ****"
    echo $need_pkg
    echo "********"
  fi
  exit 1
fi

echo x > .sed.test
sed -i s/x/y/ .sed.test >/dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "**** Your sed is too old !"
  echo "**** you need a sed version which support the -i parameter"
  exit 1
fi
rm -f .sed.test

exit 0
