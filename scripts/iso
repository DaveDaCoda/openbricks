#!/bin/sh

. config/path
. $CONFIG/options

$SCRIPTS/checkdeps || exit 1

export INSTALL=$BUILD/iso/GEEXBOX

rm -rf $BUILD/iso

mkdir -p $INSTALL/sbin
mkdir -p $INSTALL/etc
cp $CONFIG/init $INSTALL/sbin
cp $CONFIG/file_ext $INSTALL/etc
cp $CONFIG/list_ext $INSTALL/etc

$SCRIPTS/install linux modules || exit 1
$SCRIPTS/install eject || exit 1
$SCRIPTS/install alsa || exit 1
$SCRIPTS/install tvout || exit 1
$SCRIPTS/install setcd || exit 1
$SCRIPTS/install MPlayer || exit 1
if [ "$NETWORK" = yes ]; then $SCRIPTS/install network || exit 1; fi
if [ "$DEBUG" = yes ]; then $SCRIPTS/install gdb || exit 1; fi
if [ "$EXTRACODECS" = yes ]; then $SCRIPTS/install extralite || exit 1; fi

$SCRIPTS/install installator || exit 1

tar cj -C $INSTALL -f $INSTALL/bin.tar.bz2 lib usr/bin usr/lib
rm -rf $INSTALL/lib $INSTALL/usr/bin $INSTALL/usr/lib

rm -rf $BUILD/ziso
mkdir -p $BUILD/ziso
mkzftree $INSTALL $BUILD/ziso/GEEXBOX

export INSTALL=$BUILD/ziso/GEEXBOX
$SCRIPTS/install linux image || exit 1
$SCRIPTS/install initrd || exit 1
$SCRIPTS/install syslinux || exit 1

mkisofs -quiet -no-pad -V GEEXBOX -volset GEEXBOX -P "The GeeXboX team (http://www.geexbox.org/)" -p "The GeeXboX team (http://www.geexbox.org/)" -A "MKISOFS ISO 9660/HFS FILESYSTEM BUILDER" -z -D -r -J -b GEEXBOX/boot/isolinux.bin -c GEEXBOX/boot/boot.catalog -no-emul-boot -boot-load-size 4 -boot-info-table $BUILD/ziso > $ISO
