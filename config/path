set -e

GEEXBOX_VERSION=`cat VERSION`
CONFIG=config
SCRIPTS=scripts
PACKAGES=packages
SOURCES=sources
BUILD=build
DOCS=DOCS
GENERATOR=generator
INSTALLATOR=installator
ROOT=`pwd`
KERNEL_VERSION=`sed -n 's/.*\/linux-\([0-9\.]*\)\..*/\1/p' $PACKAGES/linux/url`
KERNEL=$ROOT/$BUILD/linux-$KERNEL_VERSION
GCC_VERSION=`sed -n 's/.*\/gcc-\([0-9\.]*\)\..*/\1/p' $PACKAGES/gcc/url`
TOOLCHAIN=$BUILD/toolchain
SYSROOT_PREFIX=$ROOT/$TOOLCHAIN/$TARGET_NAME/sysroot
LIB_PREFIX=$SYSROOT_PREFIX/usr/local
TARGET_PREFIX=$ROOT/$TOOLCHAIN/bin/$TARGET_NAME-
TARGET_CC=${TARGET_PREFIX}gcc
TARGET_LD=${TARGET_PREFIX}ld
TARGET_AS=${TARGET_PREFIX}as
TARGET_AR=${TARGET_PREFIX}ar
TARGET_NM=${TARGET_PREFIX}nm
TARGET_RANLIB=${TARGET_PREFIX}ranlib
TARGET_STRIP=${TARGET_PREFIX}strip
HOST_CC=$ROOT/$TOOLCHAIN/bin/host-gcc
export CCACHE_DIR=$ROOT/$BUILD/.ccache

if [ -z $PATH -o $PATH = ${PATH#$ROOT/$TOOLCHAIN/bin:} ]; then
  export PATH=$ROOT/$TOOLCHAIN/bin:$PATH
fi

setup_toolchain() {
  if [ "$1" = target ]; then
    export CC=$TARGET_CC
    export LD=$TARGET_LD
    export AS=$TARGET_AS
    export AR=$TARGET_AR
    export NM=$TARGET_NM
    export RANLIB=$TARGET_RANLIB
    export STRIP=$TARGET_STRIP
    export CPPFLAGS="-I$LIB_PREFIX/include"
    export CFLAGS="-Wall -Os -I$LIB_PREFIX/include"
    export LDFLAGS="-L$LIB_PREFIX/lib"
  elif [ "$1" = host ]; then
    export CC=$HOST_CC
    export LD=ld
    export AS=as
    export AR=ar
    export NM=nm
    export RANLIB=ranlib
    export STRIP=strip
    export CPPFLAGS=""
    export CFLAGS="-Wall -O2"
    export LDFLAGS=""
  fi

  if [ "$DEBUG" = yes ]; then
    CFLAGS="$CFLAGS -g3"
    STRIP=touch
  else
    CFLAGS="$CFLAGS -s"
    LDFLAGS="$LDFLAGS -s"
  fi
}
setup_toolchain target

SILENT_OUT=3
VERBOSE_OUT=4
if [ "$VERBOSE" = yes ]; then
  exec 3>/dev/null
  exec 4>&2
else
  exec 3>&2
  exec 4>/dev/null
fi
INDENT_SIZE=4

GEEXBOX_SRCS=http://www.geexbox.org/src/$GEEXBOX_VERSION
[ "$GEEXBOX_VERSION" = devel ] && GEEXBOX_VERSION=devel-`date +%Y%m%d`
ISO=geexbox-$GEEXBOX_VERSION
GENERATOR_NAME=geexbox-generator-$GEEXBOX_VERSION
INSTALLATOR_NAME=geexbox-installator-$GEEXBOX_VERSION
PXE_NAME=geexbox-pxe

HOST_NAME_CACHE=$BUILD/configtools/host_name
if [ -f $HOST_NAME_CACHE ]; then
  HOST_NAME=`cat $HOST_NAME_CACHE`
elif [ -x $BUILD/configtools/config.guess ]; then
  HOST_NAME=`$BUILD/configtools/config.guess`
fi
