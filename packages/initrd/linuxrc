#!/bin/busybox sh

busybox mount -t proc none /proc
busybox --install -s
echo geexbox > /proc/sys/kernel/hostname

echo "52 scanning scsi bus" > /proc/progress
rescan-scsi-bus

mount -t ramfs none /mnt/ramfs
mkdir -p /mnt/ramfs/bin
mkdir -p /mnt/ramfs/dev
mkdir -p /mnt/ramfs/etc
mkdir -p /mnt/ramfs/mnt
mkdir -p /mnt/ramfs/proc
mkdir -p /mnt/ramfs/lib
mkdir -p /mnt/ramfs/sbin
mkdir -p /mnt/ramfs/tmp
mkdir -p /mnt/ramfs/usr/bin
mkdir -p /mnt/ramfs/usr/sbin
mkdir -p /mnt/ramfs/var/run
mkdir -p /mnt/ramfs/var/log
mkdir -p /mnt/ramfs/var/lock
echo "" > /mnt/ramfs/etc/mtab
echo "" > /mnt/ramfs/etc/fstab

cp -a /dev/* /mnt/ramfs/dev
cp -a /usr/* /mnt/ramfs/usr
cp -a /lib/* /mnt/ramfs/lib/
ln -s libuClibc-*.so libc.so.6
cp /bin/busybox /mnt/ramfs/bin
ln -s busybox /mnt/ramfs/bin/sh

test -n "`grep 'installator' /proc/cmdline`" && INSTALLATOR=yes
test -n "`grep debugging /proc/cmdline`" && DEBUG=yes
BOOT=`sed 's/.*boot=\([^\ ]*\).*/\1/' /proc/cmdline`

echo "54 tweaking ide drives" > /proc/progress
for i in /proc/ide/hd*; do
  echo io_32bit:1 > $i/settings
  echo using_dma:1 > $i/settings
  echo file_readahead:2000000 > $i/settings
done

if test "$BOOT" = nfs; then
  echo "55 getting nfs tree" > /proc/progress
  NFS=`sed 's/.*nfsroot=\([^\ ]*\).*/\1/' /proc/cmdline`
  if test "$INSTALLATOR" = yes; then
    GEEXBOX=/mnt/ramfs/mnt/nfs
  else
    GEEXBOX=/mnt/nfs
  fi
  udhcpc -H geexbox -n
  mkdir -p $GEEXBOX
  mount -t nfs -o ro,nolock,nfsvers=2 $NFS $GEEXBOX
fi

echo "56 searching cdrom drives" > /proc/progress
echo -n 0 > /etc/last_cdrom
COUNT=`cut -f 5 /proc/scsi/sg/devices | grep -c 5`
for DEV in /dev/scd*; do
  NUM=`echo $DEV | sed 's%/dev/scd\(.*\)%\1%'`
  test "$NUM" -ge "$COUNT" && break
  TYPE=`/usr/bin/iscd $DEV`
  CDROM="/mnt/ramfs/mnt/cdrom $(($NUM+1))"
  mkdir "$CDROM"
  if mount -t supermount -o dev=$DEV,fs=auto none "$CDROM" 2>/dev/null >/dev/null; then
    if test "$BOOT" = cdrom -a -z "$GEEXBOX" -a -d "$CDROM/GEEXBOX"; then
      GEEXBOX="$CDROM/GEEXBOX"
      DEVICE=$DEV
      test $TYPE = DVD && DVD_DEVICE=$DEV
    fi
    test -z "$DEVICE" && DEVICE=$DEV
    test -z "$DVD_DEVICE" -a "$TYPE" = DVD && DVD_DEVICE=$DEV
    echo -n " $DEV '`echo $CDROM | sed s%/mnt/ramfs%%`'" >> /mnt/ramfs/tmp/autolaunchparam
    echo -n $(($NUM+1)) > /etc/last_cdrom
  else
    rmdir "$CDROM"
  fi
done

if test -e /mnt/ramfs/tmp/autolaunchparam; then
  echo -n "/usr/bin/autoplay" | cat - /mnt/ramfs/tmp/autolaunchparam > /mnt/ramfs/usr/bin/autolaunch
  rm /mnt/ramfs/tmp/autolaunchparam
fi

if test "$BOOT" != cdrom -a "$BOOT" != nfs; then
  echo "63 boot device detection" > /proc/progress
  while test -z "`grep $BOOT /proc/partitions`"; do
    sleep 1
  done
fi

if test "$INSTALLATOR" != yes; then
  echo "65 mounting harddisks" > /proc/progress
  DISK_NAME=
  DISK=0
  for DEV in `sed -n "s/\ *[0-9][0-9]*\ *[0-9][0-9]*\ *[0-9][0-9][0-9]*\ \([a-z]*[0-9][0-9]*\)/\1/p" /proc/partitions`; do
    NAME=`echo $DEV | sed 's/\([a-z]\{3\}\).*/\1/'`
    if test "$NAME" != "$DISK_NAME"; then
      DISK_NAME="$NAME"
      DISK=$(($DISK+1))
      PART=0
      hdparm -S24 /dev/$NAME >/dev/null
    fi
    PART=$(($PART+1))
    DIR="/mnt/ramfs/mnt/disk $DISK part $PART"
    mkdir "$DIR"
    mount -o ro /dev/$DEV "$DIR" >/dev/null 2>&1 || rmdir "$DIR"
    if test "$BOOT" != cdrom -a -z "$GEEXBOX" -a -d "$DIR/GEEXBOX/sbin" -a -f "$DIR/syslinux.cfg"; then
      GEEXBOX="$DIR/GEEXBOX"
    fi
  done
  echo -n $DISK > /etc/last_disk
else
  echo "" > /proc/sys/kernel/hotplug
  echo -n 0 > /etc/last_disk
fi

if test -n "$GEEXBOX" ; then
  echo "70 copying system into ram" > /proc/progress
  cp -a "$GEEXBOX/sbin" /mnt/ramfs/
  echo "71 copying system into ram" > /proc/progress
  cp -a "$GEEXBOX/etc" /mnt/ramfs/
  echo "73 copying system into ram" > /proc/progress
  cp -a "$GEEXBOX/usr" /mnt/ramfs/
  echo "76 copying system into ram" > /proc/progress
  tar xjf "$GEEXBOX/bin.tar.bz2" -C /mnt/ramfs/
  echo "82 copying system into ram" > /proc/progress
  mkdir -p /mnt/ramfs/codecs/
  for i in "$GEEXBOX/codecs/"*; do
    fixcodec "$i" "/mnt/ramfs/codecs/${i##*/}"
  done
  echo "85 cleaning ram disk" > /proc/progress
  test -n "$DEVICE" && ln -s "$DEVICE" /mnt/ramfs/dev/cdrom;
  test -n "$DVD_DEVICE" && ln -s "$DVD_DEVICE" /mnt/ramfs/dev/dvd;
  INIT=/sbin/init
  test -n "`grep 'installator' /proc/cmdline`" && INIT=/sbin/installator && export UID=0
else
  cp /sbin/nosystem /mnt/ramfs/sbin
  INIT=/sbin/nosystem
  echo "100 cleaning ram disk" > /proc/progress
fi

if test "$BOOT" = nfs; then
  if test "$INSTALLATOR" = yes; then
    export NFS="${GEEXBOX#/mnt/ramfs}"
  else
    umount "$GEEXBOX"
  fi
fi

if test "$BOOT" = cdrom; then
  GEEXBOX="${GEEXBOX#/mnt/ramfs}"
  export CDROM="${GEEXBOX%/GEEXBOX}"
fi
export DEBUG

umount /proc
if test "$DEBUG" = yes; then
  cp /sbin/console /mnt/ramfs/sbin
  /usr/sbin/chroot /mnt/ramfs /sbin/console </dev/tty2 >/dev/tty2 2>&1 &
fi
/usr/sbin/chroot /mnt/ramfs $INIT geexbox </dev/tty1 >/dev/tty1 2>&1

if test "$INSTALLATOR" = yes; then
  reboot
else
  poweroff
fi
