#!/bin/sh

. config/options

$SCRIPTS/build genext2fs

export INSTALL=$BUILD/initrd/mnt

rm -rf $INSTALL
mkdir -p $INSTALL
rm -f $BUILD/initrd/initrd $BUILD/initrd/initrd.gz

mkdir $INSTALL/bin
mkdir $INSTALL/etc
mkdir $INSTALL/mnt
mkdir $INSTALL/mnt/ramfs
mkdir $INSTALL/proc
mkdir $INSTALL/sbin
mkdir $INSTALL/sys
mkdir $INSTALL/usr
mkdir $INSTALL/usr/bin
mkdir $INSTALL/usr/sbin
mkdir $INSTALL/tmp

$SCRIPTS/install uClibc
$SCRIPTS/install busybox
$SCRIPTS/install udev
$SCRIPTS/install iscd

cp $PACKAGES/initrd/scripts/linuxrc $INSTALL
cp $PACKAGES/initrd/scripts/console $INSTALL/sbin
cp $PACKAGES/initrd/scripts/nosystem $INSTALL/sbin
cp $PACKAGES/initrd/scripts/r[ow] $INSTALL/usr/bin

ln -s /bin/busybox $INSTALL/bin/sh
ln -s /mnt/ramfs/dev $INSTALL/dev
ln -s /mnt/ramfs/etc/fstab $INSTALL/etc/fstab

$BUILD/genext2fs*/genext2fs -d $INSTALL -b $RAMDISK_SIZE -i 512 $BUILD/initrd/initrd

gzip -9 $BUILD/initrd/initrd
