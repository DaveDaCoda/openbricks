#!/bin/sh

. config/path

RAMDISK_SIZE=1024

$SCRIPTS/build uClibc || exit 1
$SCRIPTS/build busybox || exit 1
$SCRIPTS/build genext2fs || exit 1

export INSTALL=$BUILD/initrd/mnt

mkdir -p $INSTALL
rm -f $BUILD/initrd/initrd $BUILD/initrd/initrd.gz

mkdir $INSTALL/bin
mkdir $INSTALL/dev
mkdir -p $INSTALL/dev/snd
mkdir -p $INSTALL/dev/input
mkdir $INSTALL/mnt
mkdir $INSTALL/mnt/ramfs
mkdir $INSTALL/mnt/cdrom
mkdir $INSTALL/proc
mkdir $INSTALL/sbin
mkdir $INSTALL/usr
mkdir $INSTALL/usr/bin
mkdir $INSTALL/usr/sbin

$SCRIPTS/install uClibc || exit 1
$SCRIPTS/install busybox || exit 1
$SCRIPTS/install iscd || exit 1
$SCRIPTS/install zlib || exit 1
$SCRIPTS/install freetype || exit 1
$SCRIPTS/install bootsplash || exit 1
$SCRIPTS/install fixcodec || exit 1

cp $PACKAGES/initrd/linuxrc $INSTALL
cp $PACKAGES/initrd/console $INSTALL/sbin
cp $PACKAGES/initrd/rescan-scsi-bus $INSTALL/sbin
cp $PACKAGES/initrd/hotplug $INSTALL/sbin
cp $PACKAGES/initrd/nosystem $INSTALL/sbin
cp $PACKAGES/initrd/r[ow] $INSTALL/usr/bin

$BUILD/genext2fs*/genext2fs -d $INSTALL -f $PACKAGES/initrd/dev -b 2048 -i 512 $BUILD/initrd/initrd
rm -rf $INSTALL/*

gzip -9 $BUILD/initrd/initrd
