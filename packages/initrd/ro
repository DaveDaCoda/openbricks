#!/bin/sh

if [ -n "`echo $1 | grep '/mnt/..*'`" ]; then
  MNT=`echo $1 | sed "s%\(/mnt/[^/]*\)/.*%\1%"`
  DEV=`mount | sed 's/\\040/ /g' | sed -n "s%\(.*\) on ${MNT}.*%\1%p"`
  COUNT=`sed "s%\([0-9]*\)\ $DEV%\1%" /var/rw`
  [ "$COUNT" -lt "1" ] && exit 1
  [ "$COUNT" -eq "1" ] && mount -o remount,ro "$DEV" "$MNT"
  COUNT=$(($COUNT-1))
  sed "s%[0-9]*\ $DEV%$COUNT $DEV%" /var/rw > /var/rw.new
  mv /var/rw.new /var/rw
fi
