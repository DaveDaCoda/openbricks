#!/bin/sh
# Skript to rescan SCSI bus, using the 
# scsi add-single-device mechanism
# (w) 98/03/19 Kurt Garloff <kurt@garloff.de> (c) GNU GPL
#     03/06/18 Modified by Aurelien Jacbos <aurel@gnuage.org>

# Return hosts. /proc/scsi/HOSTADAPTER/? must exist
findhosts ()
{
  hosts=
  for name in `ls /proc/scsi/*/? 2>/dev/null`; do
    hosts="$hosts ${name##*/}"
  done
}

# Perform search (scan $host)
dosearch ()
{
  for channel in $channelsearch; do
    for id in $idsearch; do
      for lun in $lunsearch; do
	devnr="$host $channel $id $lun"
	grepstr="scsi$host Channel: 0$channel Id: 0*$id Lun: 0$lun"
	new=`cat /proc/scsi/scsi | grep "$grepstr"`
	if [ -z "$new" ]; then
	  echo "scsi add-single-device $devnr" >/proc/scsi/scsi
	fi
      done
    done
  done
}


# main
lunsearch="0"
idsearch="0 1 2 3 4 5 6 7"
channelsearch="0 1"
findhosts
for host in $hosts; do dosearch; done
