#!/bin/busybox sh

busybox mount -t proc none /proc
busybox mount -t sysfs none /sys
busybox --install -s

echo geexbox > /proc/sys/kernel/hostname

progress() {
  if test -f /proc/splash; then
    echo "show $1" > /proc/splash
  fi
  echo "### $2 ###"
}

progress 8000 "setting up ramfs tree"
mount -t ramfs none /mnt/ramfs
mkdir -p /mnt/ramfs/bin
mkdir -p /mnt/ramfs/dev
mkdir -p /mnt/ramfs/etc
mkdir -p /mnt/ramfs/mnt
mkdir -p /mnt/ramfs/proc
mkdir -p /mnt/ramfs/sys
mkdir -p /mnt/ramfs/lib
mkdir -p /mnt/ramfs/sbin
mkdir -p /mnt/ramfs/tmp
mkdir -p /mnt/ramfs/usr/bin
mkdir -p /mnt/ramfs/usr/sbin
mkdir -p /mnt/ramfs/var/run
mkdir -p /mnt/ramfs/var/log
mkdir -p /mnt/ramfs/var/lock
echo "" > /mnt/ramfs/etc/mtab
echo "" > /mnt/ramfs/etc/fstab

cp -a /dev/* /mnt/ramfs/dev
cp -a /usr/* /mnt/ramfs/usr
cp -a /lib/* /mnt/ramfs/lib/
ln -s libuClibc-*.so libc.so.6
cp /bin/busybox /mnt/ramfs/bin
ln -s busybox /mnt/ramfs/bin/sh

test -n "`grep 'installator' /proc/cmdline`" && INSTALLATOR=yes
test -n "`grep debugging /proc/cmdline`" && DEBUG=yes
BOOT=`sed 's/.*boot=\([^\ ]*\).*/\1/' /proc/cmdline`

if test "$BOOT" = nfs; then
  progress 11000 "getting nfs tree"
  NFS=`sed 's/.*nfsroot=\([^\ ]*\).*/\1/' /proc/cmdline`
  if test "$INSTALLATOR" = yes; then
    GEEXBOX=/mnt/ramfs/mnt/nfs
  else
    GEEXBOX=/mnt/nfs
  fi
  mkdir -p $GEEXBOX
  udhcpc -q -H geexbox -n && mount -t nfs -o ro,nolock,nfsvers=2 $NFS $GEEXBOX
  if [ ! -f "$GEEXBOX/bin.tar.bz2" ]; then
    umount $GEEXBOX
    rmdir $GEEXBOX
    GEEXBOX=
  fi
fi

progress 12000 "searching cdrom drives"
echo 0 > /proc/sys/dev/cdrom/autoclose
echo 0 > /proc/sys/dev/cdrom/lock
echo -n 0 > /etc/last_cdrom
IDENUM=0
COUNT=`cut -f 5 /proc/scsi/sg/devices | grep -c 5`
for DEV in /proc/ide/hd* /dev/sr*; do
  if [ -n "`echo $DEV | grep '^/proc/ide'`" ]; then
    [ "`cat $DEV/media`" != cdrom -o -n "`grep scsi $DEV/driver`" ] && continue
    DEV=`echo $DEV | sed 's%/proc/ide%/dev%'`
  else
    NUM=`echo $DEV | sed 's%/dev/sr\(.*\)%\1%'`
    test "$NUM" -ge "$COUNT" && break
  fi
  TYPE=`/usr/bin/iscd $DEV`
  CDROM="/mnt/ramfs/mnt/cdrom $(($NUM+$IDENUM+1))"
  mkdir "$CDROM"
  if mount -t supermount -o ro,dev=$DEV,fs=auto,tray_lock=onwrite none "$CDROM" 2>/dev/null >/dev/null; then
    if test "$BOOT" = cdrom -a -z "$GEEXBOX" -a -d "$CDROM/GEEXBOX"; then
      GEEXBOX="$CDROM/GEEXBOX"
      DEVICE=$DEV
      test $TYPE = DVD && DVD_DEVICE=$DEV
    fi
    test -z "$DEVICE" && DEVICE=$DEV
    test -z "$DVD_DEVICE" -a "$TYPE" = DVD && DVD_DEVICE=$DEV
    echo -n " $DEV '`echo $CDROM | sed s%/mnt/ramfs%%`'" >> /mnt/ramfs/tmp/autolaunchparam
    echo -n $(($NUM+$IDENUM+1)) > /etc/last_cdrom
  else
    rmdir "$CDROM"
  fi
  [ -n "`echo $DEV | grep '^/dev/hd'`" ] && IDENUM=$(($IDENUM+1))
done

if test -e /mnt/ramfs/tmp/autolaunchparam; then
  echo -n "/usr/bin/autoplay" > /mnt/ramfs/usr/bin/autolaunch
  cat /mnt/ramfs/tmp/autolaunchparam >> /mnt/ramfs/usr/bin/autolaunch
  echo -n " 8" >> /mnt/ramfs/usr/bin/autolaunch
  rm /mnt/ramfs/tmp/autolaunchparam
fi

if test "$BOOT" != cdrom -a "$BOOT" != nfs; then
  progress 17000 "boot device detection"
  while test -z "`grep $BOOT /proc/partitions`"; do
    sleep 1
  done
fi

if test "$INSTALLATOR" != yes; then
  progress 20000 "mounting harddisks"
  DISK_NAME=
  DISK=0
  for DEV in `sed -n "s/\ *[0-9][0-9]*\ *[0-9][0-9]*\ *[0-9][0-9][0-9]*\ \([a-z]*[0-9][0-9]*\)/\1/p" /proc/partitions`; do
    NAME=`echo $DEV | sed 's/\([a-z]\{3\}\).*/\1/'`
    if test "$NAME" != "$DISK_NAME"; then
      DISK_NAME="$NAME"
      DISK=$(($DISK+1))
      PART=0
      hdparm -c1 -S24 /dev/$NAME >/dev/null
    fi
    PART=$(($PART+1))
    DIR="/mnt/ramfs/mnt/disk $DISK part $PART"
    mkdir "$DIR"
    mount -o ro /dev/$DEV "$DIR" >/dev/null 2>&1 || rmdir "$DIR"
    if test "$BOOT" = "$DEV" -a -d "$DIR/GEEXBOX/sbin"; then
      GEEXBOX="$DIR/GEEXBOX"
    elif test "$BOOT" != cdrom -a -z "$GEEXBOX" -a -d "$DIR/GEEXBOX/sbin"; then
      GEEXBOX="$DIR/GEEXBOX"
    fi
  done
  echo -n $DISK > /etc/last_disk
else
  echo "" > /proc/sys/kernel/hotplug
  echo -n 0 > /etc/last_disk
fi

if test -n "$GEEXBOX" ; then
  progress 25000 "copying system into ram"
  cp -a "$GEEXBOX/sbin" /mnt/ramfs/
  progress 27000 "copying system into ram"
  cp -a "$GEEXBOX/etc" /mnt/ramfs/
  progress 29000 "copying system into ram"
  cp -a "$GEEXBOX/usr" /mnt/ramfs/
  progress 30500 "copying system into ram"
  cp -a "$GEEXBOX/var" /mnt/ramfs/
  progress 31000 "copying system into ram"
  tar xjf "$GEEXBOX/bin.tar.bz2" -C /mnt/ramfs/
  progress 42000 "copying system into ram"
  cp -a "$GEEXBOX/codecs" /mnt/ramfs
  progress 45000 "copying system into ram"
  test -n "$DEVICE" && ln -s "$DEVICE" /mnt/ramfs/dev/cdrom;
  test -n "$DVD_DEVICE" && ln -s "$DVD_DEVICE" /mnt/ramfs/dev/dvd;
  INIT=/sbin/init
  test -n "`grep 'installator' /proc/cmdline`" && INIT=/sbin/installator && export UID=0
else
  cp /sbin/nosystem /mnt/ramfs/sbin
  INIT=/sbin/nosystem
  progress 65535 "cleaning ram disk"
fi

if test "$BOOT" = nfs; then
  if test "$INSTALLATOR" = yes; then
    export NFS="${GEEXBOX#/mnt/ramfs}"
  elif test -n "$GEEXBOX"; then
    umount "$GEEXBOX"
  fi
fi

if test "$BOOT" = cdrom; then
  GEEXBOX="${GEEXBOX#/mnt/ramfs}"
  export CDROM="${GEEXBOX%/GEEXBOX}"
fi
export DEBUG

echo > /tmp/geexbox_loaded

if test "$DEBUG" = yes; then
  cp /sbin/console /mnt/ramfs/sbin
  /usr/sbin/chroot /mnt/ramfs /sbin/console </dev/tty2 >/dev/tty2 2>&1 &
  /sbin/console </dev/tty3 >/dev/tty3 2>&1 &
fi
/usr/sbin/chroot /mnt/ramfs /bin/sh $INIT geexbox </dev/tty1 >/dev/tty1 2>&1

if test "$INSTALLATOR" = yes; then
  reboot
else
  poweroff
fi
