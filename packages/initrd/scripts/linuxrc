#!/bin/sh

busybox mount -t proc none /proc
busybox mount -t sysfs none /sys
busybox --install -s

echo geexbox > /proc/sys/kernel/hostname
echo 0 > /proc/sys/dev/cdrom/autoclose
echo 0 > /proc/sys/dev/cdrom/lock

progress() {
  if test -f /proc/splash; then
    echo "show $1" > /proc/splash
  fi
  echo "### $2 ###"
}

progress 8000 "setting up ramfs tree"
mount -t ramfs none /mnt/ramfs
mkdir -p /mnt/ramfs/bin
mkdir -p /mnt/ramfs/dev
mkdir -p /mnt/ramfs/etc
mkdir -p /mnt/ramfs/mnt
mkdir -p /mnt/ramfs/proc
mkdir -p /mnt/ramfs/sys
mkdir -p /mnt/ramfs/lib
mkdir -p /mnt/ramfs/sbin
mkdir -p /mnt/ramfs/tmp
mkdir -p /mnt/ramfs/usr/bin
mkdir -p /mnt/ramfs/usr/sbin
mkdir -p /mnt/ramfs/var/run
mkdir -p /mnt/ramfs/var/log
mkdir -p /mnt/ramfs/var/lock

echo -n "" > /mnt/ramfs/etc/mtab
echo -n "" > /mnt/ramfs/etc/fstab
echo -n "" > /mnt/ramfs/etc/mnts

udevstart
echo /sbin/udevsend > /proc/sys/kernel/hotplug

cp -a /usr/* /mnt/ramfs/usr
cp -a /lib/* /mnt/ramfs/lib/
ln -s libuClibc-*.so libc.so.6
cp /bin/busybox /mnt/ramfs/bin
ln -s busybox /mnt/ramfs/bin/sh

grep -q installator /proc/cmdline && INSTALLATOR=yes
grep -q debugging /proc/cmdline && DEBUG=yes
BOOT=`sed 's/.*boot=\([^\ ]*\).*/\1/' /proc/cmdline`

if test "$BOOT" = nfs; then
  progress 11000 "getting nfs tree"
  NFS=`sed 's/.*nfsroot=\([^\ ]*\).*/\1/' /proc/cmdline`
  if test "$INSTALLATOR" = yes; then
    GEEXBOX=/mnt/ramfs/mnt/nfs
  else
    GEEXBOX=/mnt/nfs
  fi
  mkdir -p $GEEXBOX
  udhcpc -q -H geexbox -n && mount -t nfs -o ro,nolock,nfsvers=2 $NFS $GEEXBOX
  if [ ! -f "$GEEXBOX/bin.tar.lzma" ]; then
    umount $GEEXBOX
    rmdir $GEEXBOX
    GEEXBOX=
  fi
fi

IFS='
'

progress 12000 "searching cdrom drives"
if [ "$BOOT" = cdrom ]; then
  for DEV in `grep '^/dev/cdrom' /etc/mnts | cut -f1`; do
    CDROM=`grep "^$DEV	" /etc/mnts | cut -f2-`
    if [ -d "$CDROM/GEEXBOX" ]; then
      GEEXBOX="$CDROM/GEEXBOX"
      ln -s "$DEV" /dev/cdrom
      break
    fi
  done
fi
[ ! -e /dev/cdrom -a -b /dev/cdrom0 ] && ln -s /dev/cdrom0 /dev/cdrom

if [ "$BOOT" != cdrom -a "$BOOT" != nfs ]; then
  if [ "$INSTALLATOR" != yes ]; then
    progress 17000 "boot device detection"
    sleep 5
    BOOT=`cd /dev; ls -l $BOOT | sed 's/.* \([^ ]*\)$/\1/'`
    for DEV in `grep '^/dev/disk' /etc/mnts | cut -f1`; do
      DIR=`grep "^$DEV	" /etc/mnts | cut -f2-`
      if [ -d "$DIR/GEEXBOX" ]; then
        GEEXBOX="$DIR/GEEXBOX"
        [ "/dev/$BOOT" = "$DEV" ] && break
      fi
    done
  fi
fi

if test -n "$GEEXBOX" ; then
  progress 25000 "copying system into ram"
  cp -a "$GEEXBOX/sbin" /mnt/ramfs/
  progress 27000 "copying system into ram"
  cp -a "$GEEXBOX/etc" /mnt/ramfs/
  progress 29000 "copying system into ram"
  cp -a "$GEEXBOX/usr" /mnt/ramfs/
  progress 30500 "copying system into ram"
  cp -a "$GEEXBOX/var" /mnt/ramfs/
  progress 31000 "copying system into ram"
  lzmacat "$GEEXBOX/bin.tar.lzma" | tar xf - -C /mnt/ramfs
  progress 42000 "copying system into ram"
  cp -a "$GEEXBOX/codecs" /mnt/ramfs
  progress 45000 "copying system into ram"
  INIT=/sbin/init
else
  cp /sbin/nosystem /mnt/ramfs/sbin
  INIT=/sbin/nosystem
  progress 65535 "cleaning ram disk"
fi

if test "$BOOT" = nfs; then
  if test "$INSTALLATOR" = yes; then
    export NFS="${GEEXBOX#/mnt/ramfs}"
  elif test -n "$GEEXBOX"; then
    umount "$GEEXBOX"
  fi
fi

if test "$BOOT" = cdrom; then
  GEEXBOX="${GEEXBOX#/mnt/ramfs}"
  export CDROM="${GEEXBOX%/GEEXBOX}"
fi

RUNLEVEL="geexbox"
if test "$INSTALLATOR" = yes; then
  RUNLEVEL="install"
elif test "$DEBUG" = yes; then
  RUNLEVEL="debug"
fi

if test "$DEBUG" = yes; then
  cp /sbin/console /mnt/ramfs/sbin
  /usr/sbin/chroot /mnt/ramfs /sbin/console </dev/tty2 >/dev/tty2 2>&1 &
  /sbin/console </dev/tty3 >/dev/tty3 2>&1 &
fi
/usr/sbin/chroot /mnt/ramfs /bin/sh $INIT $RUNLEVEL </dev/tty1 >/dev/tty1 2>&1

if test "$INSTALLATOR" = yes; then
  reboot
else
  poweroff
fi
