#!/bin/sh

case "$1" in
  scsi_device)
    case $ACTION in
      add)
        (
          sleep 1

          BLOCK_DEV=`cat /sys/$DEVPATH/device/block/dev` || exit 1
          BLOCKS=`ls /sys/block`
          for i in $BLOCKS; do
            [ `cat /sys/block/$i/dev` = $BLOCK_DEV ] && SCSI_DEVICE=$i
          done

          if [ -z "`echo $SCSI_DEVICE | grep sr`" ]; then
            DISK=`cat /etc/last_disk`
            DISK=$(($DISK+1))
            PART=0
            for DEV in `ls /sys/block/$SCSI_DEVICE | grep $SCSI_DEVICE`; do
              PART=$(($PART+1))
              DIR="/mnt/ramfs/mnt/disk $DISK part $PART"
              mkdir "$DIR"
              mount -o ro /dev/$DEV "$DIR" >/dev/null 2>&1 || rmdir "$DIR"
            done
            echo -n $DISK > /etc/last_disk
          else
            NUM=`cat /etc/last_cdrom`
            NUM=$(($NUM+1))
            CDROM="/mnt/ramfs/mnt/cdrom $NUM"
            mkdir "$CDROM"
            mount -t supermount -o ro,dev=/dev/$SCSI_DEVICE none "$CDROM" >/dev/null 2>&1 || rmdir "$CDROM"
            echo -n $NUM > /etc/last_cdrom
          fi
        ) &
      ;;
  esac
esac
