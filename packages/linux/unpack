#!/bin/sh

. config/options

$SCRIPTS/install make
$SCRIPTS/install sed
$SCRIPTS/unpack lzma

LINUX="`ls -d $BUILD/linux*`"

sed -i -e "s|^HOSTCC[[:space:]]*=.*$|HOSTCC = $HOST_CC|" \
       -e "s|^HOSTCXX[[:space:]]*=.*$|HOSTCXX = $HOST_CXX|" \
       -e "s|^ARCH[[:space:]]*?=.*$|ARCH ?= $TARGET_ARCH|" \
       -e "s|^CROSS_COMPILE[[:space:]]*?=.*$|CROSS_COMPILE ?= $TARGET_PREFIX|" \
       $LINUX/Makefile

sed "s/CONFIG_BLK_DEV_RAM_SIZE=.*/CONFIG_BLK_DEV_RAM_SIZE=$RAMDISK_SIZE/" $PACKAGES/linux/config/linux.$TARGET_ARCH.conf > $LINUX/.config

cp $BUILD/lzma*/SRC/7zip/Compress/LZMA_C/LzmaDecode.[ch] $LINUX/lib/
sed -i "s%^int Lzma%static int Lzma%g" $LINUX/lib/LzmaDecode.[ch]

make oldconfig ARCH=$TARGET_ARCH -C $LINUX

make prepare0 ARCH=$TARGET_ARCH -C $LINUX
