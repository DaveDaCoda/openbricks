#!/bin/sh
#
# setup dvb cards
#
# runlevels: geexbox, debug, install

echo "### Setting up DVB card ###"

# DVB frontends drivers are auto-loaded by main device drivers

# PCI DVB Devices
if test -n "`grep 'Class 0400:.*109e:' /proc/pci`"; then
  # BT8x8 Card
  modprobe dvb-bt8xx >/dev/null 2>&1
  modprobe dst >/dev/null 2>&1
elif test -n "`grep 'Class 0480:.*1131:' /proc/pci`"; then
  # SAA7134 Card
  modprobe saa7134-dvb >/dev/null 2>&1
  # SAA7146 Cards
  modprobe saa7146 >/dev/null 2>&1
  modprobe saa7146_vv >/dev/null 2>&1
  modprobe dvb-ttpci >/dev/null 2>&1
  modprobe budget >/dev/null 2>&1
  modprobe budget-ci >/dev/null 2>&1
  modprobe budget-av >/dev/null 2>&1
elif test -n "`grep 'Class 0480:.*13d0:' /proc/pci`"; then
  # B2C2 Cards
  modprobe budget >/dev/null 2>&1
  modprobe b2c2-flexcop-pci >/dev/null 2>&1
  modprobe b2c2-flexcop >/dev/null 2>&1
elif test -n "`grep 'Class 0480:.*14f1:88' /proc/pci`"; then
  # Conexant CX88 Card
  modprobe cx88-blackbird >/dev/null 2>&1
  modprobe cx88-dvb >/dev/null 2>&1
elif test -n "`grep 'Class 0480:.*0432:' /proc/pci`"; then
  # SCM Pluto2 Card
  modprobe pluto2 >/dev/null 2>&1
fi

# USB DVB Devices
if test -n "`grep 'Vendor=0b48' /proc/bus/usb/devices`"; then
  # Hauppauge/TT Nova-USB budget
  modprobe ttusb-budget >/dev/null 2>&1
  # Hauppauge/TT DEC2000-t/DEC2540-t/DEC3000-s
  modprobe ttusb-dec >/dev/null 2>&1
elif test -n "`grep 'Vendor=1822' /proc/bus/usb/devices`" \
          -a -z "`grep 'Vendor=13d3' /proc/bus/usb/devices`" \
          -a -z "`grep 'Vendor=eb1a' /proc/bus/usb/devices`" \
          -a -z "`grep 'Vendor=10b8' /proc/bus/usb/devices`" \
          -a -z "`grep 'Vendor=05d8' /proc/bus/usb/devices`" \
          -a -z "`grep 'Vendor=185b' /proc/bus/usb/devices`"; then
  # DiBcom DVB-T USB1.1 (Twinhan, KWorld, Hama, Artec, Compro)
  modprobe dvb-dibusb >/dev/null 2>&1
elif test -n "`grep 'Vendor=0ccd ProdID=0038' /proc/bus/usb/devices`"; then
  # TerraTec Cynergy T2
  modprobe cynergyT2 >/dev/null 2>&1
elif test -n "`grep 'Vendor=0af7' /proc/bus/usb/devices`"; then
  # B2C2 FlexCop USB
  modprobe budget >/dev/null 2>&1
  modprobe b2c2-flexcop-usb >/dev/null 2>&1
  modprobe b2c2-flexcop >/dev/null 2>&1
fi

# ensure that DVB card has been discovered
if test -n "`dmesg | grep 'DVB: registering new adapter'`"; then
  # ensure frontend is present
  if test -n "`dmesg | grep 'DVB: registering frontend'`"; then
    echo -n "" > /var/dvbcard
  fi
fi

exit 0
