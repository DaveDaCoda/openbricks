#!/bin/sh
#
# setup tv cards

echo "### Setting up TV card ###"

if test -z "`grep 'Class 0400:.*109e:' /proc/pci`" \
     -a -z "`grep 'Class 0480:.*1131:' /proc/pci`"; then
  # No supported TV card found
  exit 1
fi

. /etc/tvcard

CARD=
test "$TV_CARD" != "AUTO" && CARD="card=$TV_CARD"
TUNER=
test "$TV_TUNER" != "AUTO" && TUNER="tuner=$TV_TUNER"

if test -n "`grep 'Class 0400:.*109e:' /proc/pci`"; then
  # BT8x8 Card
  modprobe bttv $CARD $TUNER >/dev/null 2>&1

  if test "$TV_CARD" = "AUTO" \
       -a -z "`dmesg | grep 'bttv0: detected'`"; then
    # Not autodetected
    test -z "$TUNER" && TUNER="tuner=3"
    rmmod bttv
    modprobe bttv card=1 $TUNER >/dev/null 2>&1
  fi

  echo "TV_WIDTH=768" > /var/tvcard
  echo "TV_HEIGHT=576" >> /var/tvcard
elif test -n "`grep 'Class 0480:.*1131:' /proc/pci`"; then
  # SAA7134 Card
  modprobe saa7134 $CARD $TUNER >/dev/null 2>&1

  echo -n "" > /var/tvcard
fi

modprobe tuner >/dev/null 2>&1
modprobe tvaudio >/dev/null 2>&1
modprobe msp3400 >/dev/null 2>&1
modprobe tda7432 >/dev/null 2>&1
modprobe tda9875 >/dev/null 2>&1
modprobe tda9887 >/dev/null 2>&1

exit 0
