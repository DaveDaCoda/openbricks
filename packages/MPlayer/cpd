#!/bin/sh

FIFO=/var/cp_fifo
DIR=

mkfifo $FIFO 2>/dev/null

while true; do
  read CMD FILE < $FIFO

  case "$CMD" in
    cd)
      DIR=$FILE
      [ -d "$DIR" ] || DIR=${DIR%/[^/]*}
      ;;

    cp)
      [ -z "$DIR" ] && continue
      if [ -n "`echo $DIR | grep '/mnt/..*'`" ]; then
        MNT=`echo $DIR | sed "s%\(/mnt/[^/]*\)/.*%\1%"`
        DEV=`mount | sed 's/\\040/ /g' | sed -n "s%\(.*\) on ${MNT}.*%\1%p"`
        mount -o remount,rw "$DEV" "$MNT"
      fi
      cp "$FILE" "$DIR"
      if [ -n "$MNT" ]; then
        mount -o remount,ro "$DEV" "$MNT"
      fi
      ;;

    exit)
      break;
      ;;
  esac
done

rm $FIFO
