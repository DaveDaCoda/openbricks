#!/bin/sh

# MEncoder/MPlayer stream recorder
# usage: mp_recorder file_location

MENCODER=/usr/bin/mencoder
CFG=/etc/mplayer/mencoder.conf

RECORD_SOURCE=/var/record_source
RECORD_PROFILE=/var/record_profile
RECORD_STATUS=/var/record_status
RECORDER_CFG=/etc/recorder

mp_fifo=/var/mp_control

file=$1

if [ ! -f $RECORD_STATUS ]; then
  [ "$file" == "" ] && exit 1 # No source to record from.

  . $RECORDER_CFG
  if [ "$SAVE_PATH" = "/tmp" ]; then
    # default configuration : won't save to RAMdisk.
    exit 1
  fi

  if [ ! -d "$SAVE_PATH" ]; then
    # not a valid directory : bails out
    exit 1
  fi

  # Remounts the required disk RW in order to write to
  rw "$SAVE_PATH"

  # Set recording destination filename
  DATE=$(date '+%F')
  HOUR=$(date '+%H')
  MIN=$(date '+%M')
  OUTPUT=record-$DATE-$HOUR-$MIN

  # Start Recording
  sed -i -e "s|^o=\".*\.\(.*\)\"|o=\"$SAVE_PATH/$OUTPUT\.\1\"|" $CFG

  PROFILE=`cat $RECORD_PROFILE`
  $MENCODER -profile $PROFILE "$file" 2>&1 > /dev/null &

  # Gives MEncoder a few time to be start and plays recording file.
  sleep 5
  echo "loadfile \"$SAVE_PATH/$OUTPUT\"" > $mp_fifo

  # Displays recording message.
  sleep 1
  echo "osd_show_text \"Recording ...\"" > $mp_fifo

  # Keep trace of original stream source in order to restore it at
  # the end of recording session
  echo "SOURCE=\"$file\"" > $RECORD_SOURCE

  # Create recorder status file.
  echo "" > $RECORD_STATUS
elif [ -f $RECORD_STATUS ]; then
  # Stop MEncoder recording
  killall -9 mencoder

  # Remounts the required disk RO for safety.
  . $RECORDER_CFG
  ro "$SAVE_PATH"

  # Reload the original source.
  . $RECORD_SOURCE
  echo "loadfile $SOURCE" > $mp_fifo

  # Displays recorded file name.
  echo "osd_show_text \"$file\"" > $mp_fifo

  # Remove recorder status file
  rm $RECORD_STATUS
fi

