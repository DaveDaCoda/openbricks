#!/bin/sh
#
# configure MPlayer's audio settings

echo "### Configuring MPlayer's audio settings ###"

# include audio configuration file
. /etc/audio

echo $ALSA_CARD | grep -q ".." || ALSA_CARD="0$ALSA_CARD"

case $SOUNDCARD_MODE in
  SPDIF)  ALSA_REAL_MODE=IEC958 ;;
  analog) ALSA_REAL_MODE=DAC    ;;
esac

ALSA_DEVICE=`sed -n "s/^$ALSA_CARD-\(..\): .*$ALSA_REAL_MODE.*/\1/p" /proc/asound/pcm | head -1`
[ -z "$ALSA_DEVICE" ] && ALSA_DEVICE=`sed -n "s/^$ALSA_CARD-\(..\): .*playback.*/\1/p" /proc/asound/pcm | head -1`

[ -n "$ALSA_DEVICE" ] && AO_DEVICE=":device=hw=$ALSA_CARD.$ALSA_DEVICE"

# set alsa as audio output isn't forced already.
grep -q "^ao=" /etc/mplayer/mplayer.conf || echo "ao=alsa$AO_DEVICE" >> /etc/mplayer/mplayer.conf

# enable hardware AC3 output via S/PDIF if audio codec isn't forced already.
if [ "$SOUNDCARD_MODE" = SPDIF -a "$AC3_DECODER" = hardware ]; then
  grep -q "^ac=" /etc/mplayer/mplayer.conf || echo "ac=hwac3," >> /etc/mplayer/mplayer.conf
  CHANNELS=2
fi

# set number of playback channels if isn't forced already.
grep -q "^channels=" /etc/mplayer/mplayer.conf || echo "channels=$CHANNELS" >> /etc/mplayer/mplayer.conf

# set DVD default language
echo "alang=`sed 's/^\(..\).*/\1/' /etc/lang | head -1`,en" >> /etc/mplayer/mplayer.conf

# Set suitable background movie when playing audio-only.
for i in background-audio.avi background.avi; do
  if [ -f /usr/share/mplayer/$i ]; then
    echo "bgvideo=/usr/share/mplayer/$i" >> /etc/mplayer/mplayer.conf
    break
  fi
done

exit 0
