#!/bin/sh
#
# setup MEncoder recording profiles menu
#
# runlevels: geexbox, debug

CFG=/etc/mplayer/mencoder.conf
MENU=/etc/mplayer/menu.conf
RECORD_CFG=/etc/recorder
HELP=/usr/share/mplayer/help.txt

echo "### Building MEncoder profiles selection menu ###"

[ -f $RECORD_CFG ] && . $RECORD_CFG

# Add list of supported encoding profiles
if [ -x /usr/bin/mencoder -a ! -z "$SAVE_PATH" ]; then
  echo "" >> $MENU
  echo "<cmdlist name=\"profile_sel\" title=\"Encoding Profile\" ptr=\"\" item-bg=\"-1\" title-bg=\"-1\" ptr-bg=\"164\" >" >> $MENU
  for profile in `grep "^\[" $CFG | grep -v common | grep -v dump | sed 's/\[//' | sed 's/\]//'`; do
    desc=`grep -A 1 "\[$profile\]" $CFG | grep profile-desc | sed 's/.*profile-desc=\"\(.*\)\"/\1/'` 
    echo "  <e name=\"$desc\" ok=\"run 'sed -i s/^RECORD_PROFILE.*/RECORD_PROFILE=$profile/ $RECORD_CFG'\"/>" >> $MENU
  done
  echo "</cmdlist>" >> $MENU
else
  # no encoder available
  sed -i -e 's/.*ok="set_menu recorder".*//' -e 's/.*ok="set_menu profile_sel".*//' $MENU
  sed -i "s/^i  :.*//" $HELP
fi

exit 0
