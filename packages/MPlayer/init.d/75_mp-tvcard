#!/bin/sh
#
# configure MPlayer's v4l2 settings

echo "### Configuring MPlayer's v4l2 support ###"

if [ -f /var/tvcard ]; then
  . /etc/tvcard
  . /var/tvcard

  # configure mplayer v4l2 driver
  if [ -n "$TV_WIDTH" -a -n "$TV_HEIGHT" ]; then
    TV_OPTIONS=":width=$TV_WIDTH:height=$TV_HEIGHT"
  fi
  echo "tv=driver=v4l2:norm=$TVIN_STANDARD:chanlist=$CHANLIST$TV_OPTIONS" >> /etc/mplayer/mplayer.conf

  # set mplayer TV channels list
  echo "<cmdlist name=\"tv_chan\" title=\"TV Channels\" ptr=\"<>\" >" >> /etc/mplayer/menu.conf
  grep '^CHAN' /etc/tvcard | sed 's/^CHAN="\([^:]*\):\(.*\)"/<e name=\"\2\" ok=\"loadfile tv:\/\/\1\"\/>/' >> /etc/mplayer/menu.conf
  echo "</cmdlist>" >> /etc/mplayer/menu.conf
else
  # remove tv options from menu
  sed -i 's/.*ok="set_menu tv_settings".*//' /etc/mplayer/menu.conf
  sed -i 's/.*ok="set_menu tv_norm"*//' /etc/mplayer/menu.conf
fi

exit 0
