#!/bin/sh
#
# configure DXR3/Hollywood+ cards for MPlayer

echo "### Configuring DXR3/Hollywood+ cards for MPlayer ###"

# include audio configuration file
. /etc/audio

# include tvout configuration file
. /etc/tvout

# set ao, vo and vf for DXR3/Hollywood+ cards and upload microcode.
if test -n "`grep 'Class 0480:.*1105:8300' /proc/pci 2>/dev/null`"; then
  sed -i 's/^vo=.*/vo=dxr3:sync:norm=0/' /etc/mplayer/mplayer.conf
  sed -i 's/^ao=.*/ao=oss:\/dev\/em8300_ma-0/' /etc/mplayer/mplayer.conf
  if [ -n "`grep '^vf=' /etc/mplayer/mplayer.conf`" ]; then
    sed -i 's/^\(vf=.*\)/\1,expand=-1:-1:-1:-1:1/' /etc/mplayer/mplayer.conf
  else
    echo 'vf=expand=-1:-1:-1:-1:1' >> /etc/mplayer/mplayer.conf
  fi
  sed -i "s%play_dvd.*%quit 167\"/>%" /etc/mplayer/menu.conf
  em8300setup -p -a -o -f /usr/share/em8300.uc >/dev/null 2>&1
  echo '' > /var/use_dxr3

  # TVOut standard (default is PAL)
  if [ "$TVOUT_STANDARD" = "ntsc" ]; then
    em8300setup -n >/dev/null 2>&1
  fi

  # set display to WideScreen format (default is 4:3)
  if [ "$TVOUT_ASPECT" = "16:9" ]; then
    em8300setup -w >/dev/null 2>&1
  fi

  # use SPDIF output ?
  if [ "$SOUNDCARD_MODE" = SPDIF ]; then
    em8300setup -d >/dev/null 2>&1
  fi
fi

exit 0
