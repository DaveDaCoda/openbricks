#!/bin/sh

. config/path
. $CONFIG/options

$SCRIPTS/build uClibc || exit 1
$SCRIPTS/build lirc || exit 1
$SCRIPTS/build libogg || exit 1
$SCRIPTS/build libvorbis || exit 1
$SCRIPTS/build cdparanoia || exit 1
$SCRIPTS/build zlib || exit 1
$SCRIPTS/build alsa || exit 1

if [ "$DXR3" = "yes" ]; then
    $SCRIPTS/build em8300 || exit 1
    DXR3_CONFIG="--enable-qtx --enable-dxr3 --enable-ossaudio"
    DXR3_INC="-I`ls -d $ROOT/$BUILD/em8300-*/include`"
    DXR3_LIBS="-L`ls -d $ROOT/$BUILD/em8300-*/libdxr3/.libs`"
else
    DXR3_CONFIG="--disable-qtx --disable-dxr3 --disable-ossaudio"
    DXR3_INC=""
    DXR3_LIBS=""
fi

if [ "$DIRECTFB" = "yes" ]; then
    $SCRIPTS/build DirectFB || exit 1
    DFB_CONFIG="--enable-directfb"
    DFB_LIBS="-L`ls -d $ROOT/$BUILD/DirectFB-*/src/.libs`"
    export _inc_directfb="-I`ls -d $ROOT/$BUILD/DirectFB-*/include`"
    export PATH="`ls -d $ROOT/$BUILD/uClibc*/build/usr/bin`:$PATH"
    export LD_LIBRARY_PATH="`ls -d $ROOT/$BUILD/DirectFB-*/src/.libs`"
else
    DFB_CONFIG="--disable-directfb"
    DFB_LIBS=""
fi

if [ "$FONT" = "truetype" ]; then
  $SCRIPTS/build freetype || exit 1
  FT_CONFIG="`ls -d $ROOT/$BUILD/freetype-*/build/bin/freetype-config`"
  TT_CONFIG="--enable-iconv --enable-freetype --with-freetype-config=$FT_CONFIG"
  TT_LIBS=`$FT_CONFIG --libtool | sed s/libfreetype\\.la/libfreetype.a/`
else
  TT_CONFIG="--disable-iconv --disable-freetype"
  TT_LIBS=""
fi

if [ $DEBUG = "yes" ]; then
  OPTS="--enable-debug=3"
fi

UCBIN=`ls -d $ROOT/$BUILD/uClibc-*/build/usr/bin`
CWD=`pwd`

cd `ls -d $BUILD/MPlayer-*` && \
./configure $OPTS \
            --prefix=/usr \
            --confdir=/etc/mplayer \
            $DXR3_CONFIG \
            --disable-mencoder \
            --disable-gui \
            --enable-largefiles \
            --disable-linux-devfs \
            --disable-termcap \
            --disable-setlocale \
            --enable-lirc \
            --disable-lircc \
            --disable-joystick \
            --disable-tv \
            --disable-tv-v4l \
            --disable-tv-v4l2 \
            --disable-tv-bsdbt848 \
            --disable-edl \
            --enable-rtc \
            --disable-network \
            --disable-winsock2 \
            --disable-smb \
            --disable-live \
            --disable-dvdread \
            --enable-mpdvdkit \
            --enable-cdparanoia \
            $TT_CONFIG \
            --disable-fontconfig \
            --enable-unrarlib \
            --enable-menu \
            --disable-sortsub \
            --disable-fribidi \
            --disable-macosx \
            --disable-inet6 \
            --disable-gethostbyname2 \
            --disable-ftp \
            --disable-gif \
            --disable-png \
            --disable-jpeg \
            --disable-liblzo \
            --enable-win32 \
            --enable-dshow \
            --disable-xanim \
            --enable-real \
            --with-reallibdir=/codecs \
            --with-win32libdir=/codecs \
            --disable-xvid \
            --disable-divx4linux \
            --disable-opendivx \
            --enable-libavcodec \
            --disable-libfame \
            --enable-vorbis \
            --disable-tremor \
            --disable-theora \
            --enable-internal-matroska \
            --disable-external-faad \
            --enable-internal-faad \
            --disable-libdv \
            --disable-mad \
            --enable-flac \
            --disable-external-flac \
            --enable-vidix --disable-gl \
            --disable-dga \
            --enable-vesa \
            --disable-svga \
            --disable-sdl \
            --disable-aa \
            --disable-ggi \
            --disable-directx \
            --disable-dxr2 \
            --disable-dvb \
            --disable-dvbhead \
            --disable-mga \
            --disable-xmga \
            --disable-xv \
            --disable-xvmc \
            --disable-vm \
            --disable-xinerama \
            --disable-x11 \
            --disable-fbdev \
            --disable-mlib \
            --disable-3dfx \
            --disable-tdfxfb \
            $DFB_CONFIG \
            --disable-zr \
            --disable-bl \
            --disable-tdfxvid \
            --disable-tga \
            --disable-arts \
            --disable-esd \
            --enable-alsa \
            --disable-sunaudio \
            --disable-nas \
            --disable-win32waveout \
            --disable-select \
            --enable-runtime-cpudetection \
            --cc=$UCBIN/gcc \
            --language=en \
            --disable-i18n \
            --disable-dynamic-plugins \
            --disable-additional-filters \
            --with-cdparanoiaincdir="`ls -d $ROOT/$BUILD/cdparanoia-*/paranoia`" \
            --with-cdparanoialibdir="`ls -d $ROOT/$BUILD/cdparanoia-*/paranoia`" \
            --with-extraincdir="`ls -d $ROOT/$BUILD/lirc-*` -I`ls -d $ROOT/$BUILD/libogg-*/include` -I`ls -d $ROOT/$BUILD/libvorbis-*/include` -I`ls -d $ROOT/$BUILD/zlib-*` -I`ls -d $ROOT/$BUILD/alsa-lib-*/include` $DXR3_INC" \
            --with-extralibdir="`ls -d $ROOT/$BUILD/lirc-*/lirc/.libs` -L`ls -d $ROOT/$BUILD/libogg-*/src/.libs` -L`ls -d $ROOT/$BUILD/libvorbis-*/lib/.libs` -L`ls -d $ROOT/$BUILD/zlib-*` -L`ls -d $ROOT/$BUILD/alsa-lib-*/src/.libs`  $DXR3_LIBS $TT_LIBS $DFB_LIBS" && \
sed -i s/-lnsl// config.mak && \
sed -i s/.*USE_MP3LIB.*// config.h && \
sed -i s/.*USE_LIBMPEG2.*// config.h && \
sed -i 's/.*HAVE_VSSCANF.*/#define HAVE_VSSCANF 1/' config.h && \
sed -i 's/.*HAVE_LRINTF.*/#define HAVE_LRINTF 1/' config.h && \
make version.h && \
gcc -O4 -Iloader -I. codec-cfg.c mp_msg.c -o codec-cfg -DCODECS2HTML && \
export UCLIBC_GCC_DLOPT="-Wl,--dynamic-linker,/lib/ld-uClibc.so.0" && \
export LD="$UCBIN/ld --dynamic-linker /lib/ld-uClibc.so.0" && \
make OPTFLAGS="-Os -mcpu=pentium -march=pentium -DHAVE_MPLAYER -pipe -ffast-math -fomit-frame-pointer -D_REENTRANT -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -D__USE_EXTERN_INLINES -DFIXED_POINT" && \
([ $DEBUG = "yes" ] || strip mplayer libdha/libdha.so vidix/drivers/*.so) && \
cd "$CWD" && \
exit 0

cd "$CWD"
exit 1
