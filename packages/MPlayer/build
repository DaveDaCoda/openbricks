#!/bin/sh

. config/options

$SCRIPTS/build toolchain || exit 1
$SCRIPTS/build lirc || exit 1
$SCRIPTS/build libogg || exit 1
$SCRIPTS/build libvorbis || exit 1
$SCRIPTS/build libtheora || exit 1
$SCRIPTS/build libdts || exit 1
$SCRIPTS/build cdparanoia || exit 1
$SCRIPTS/build zlib || exit 1
$SCRIPTS/build alsa || exit 1
$SCRIPTS/build freetype || exit 1
$SCRIPTS/build fribidi || exit 1

if [ "$BTTV" = "yes" ]; then
  BTTV_CONFIG="--enable-tv --disable-tv-v4l --enable-tv-v4l2 --disable-tv-bsdbt848"
else
  BTTV_CONFIG="--disable-tv --disable-tv-v4l --disable-tv-v4l2 --disable-tv-bsdbt848"
fi

if [ "$DXR3" = "yes" ]; then
  $SCRIPTS/build em8300 || exit 1
  DXR3_CONFIG="--enable-qtx --enable-dxr3 --enable-ossaudio"
else
  DXR3_CONFIG="--disable-qtx --disable-dxr3 --disable-ossaudio"
fi

CFLAGS="$CFLAGS -mcpu=pentium -march=pentium -pipe -ffast-math -fomit-frame-pointer -DFIXED_POINT -D__USE_EXTERN_INLINES"

CWD=`pwd`

cd $BUILD/MPlayer* && \
./configure --prefix=/usr \
            --confdir=/etc/mplayer \
            --with-extralibdir="$LIB_PREFIX/lib" \
            --with-extraincdir="$LIB_PREFIX/include" \
            $DXR3_CONFIG \
            --disable-mencoder \
            --disable-gui \
            --enable-largefiles \
            --disable-linux-devfs \
            --disable-termcap \
            --disable-setlocale \
            --enable-lirc \
            --disable-lircc \
            --enable-joystick \
            $BTTV_CONFIG \
            --disable-edl \
            --enable-rtc \
            --enable-network \
            --disable-winsock2 \
            --disable-smb \
            --disable-live \
            --disable-dvdread \
            --enable-mpdvdkit \
            --enable-cdparanoia \
            --enable-iconv \
            --enable-freetype \
            --with-freetype-config="$LIB_PREFIX/bin/freetype-config" \
            --disable-fontconfig \
            --enable-fribidi \
            --with-fribidi-config="$LIB_PREFIX/bin/fribidi-config" \
            --enable-unrarlib \
            --enable-menu \
            --disable-sortsub \
            --disable-macosx \
            --disable-inet6 \
            --disable-gethostbyname2 \
            --disable-ftp \
            --disable-gif \
            --disable-png \
            --disable-jpeg \
            --disable-liblzo \
            --enable-win32 \
            --enable-dshow \
            --disable-xanim \
            --enable-real \
            --with-reallibdir=/codecs \
            --with-win32libdir=/codecs \
            --disable-xvid \
            --disable-divx4linux \
            --disable-opendivx \
            --enable-libavcodec \
            --disable-libfame \
            --enable-vorbis \
            --disable-tremor \
            --enable-theora \
            --enable-internal-matroska \
            --disable-external-faad \
            --enable-internal-faad \
            --disable-libdv \
            --disable-mad \
            --enable-libdts \
            --enable-vidix --disable-gl \
            --disable-dga \
            --enable-vesa \
            --disable-svga \
            --disable-sdl \
            --disable-aa \
            --disable-ggi \
            --disable-directx \
            --disable-dxr2 \
            --disable-dvb \
            --disable-dvbhead \
            --disable-mga \
            --disable-xmga \
            --disable-xv \
            --disable-xvmc \
            --disable-vm \
            --disable-xinerama \
            --disable-x11 \
            --disable-fbdev \
            --disable-mlib \
            --disable-3dfx \
            --disable-tdfxfb \
            --disable-directfb \
            --disable-zr \
            --disable-bl \
            --disable-tdfxvid \
            --disable-tga \
            --disable-arts \
            --disable-esd \
            --enable-alsa \
            --disable-sunaudio \
            --disable-nas \
            --disable-win32waveout \
            --disable-select \
            --disable-mp3lib \
            --disable-libmpeg2 \
            --enable-runtime-cpudetection \
            --target=$SHORT_TARGET_NAME \
            --as=$AS \
            --cc=$CC \
            --language=en \
            --disable-i18n \
            --disable-dynamic-plugins \
            --disable-additional-filters && \
sed -i s/-lnsl// config.mak && \
([ $DEBUG != "yes" ] || sed -i 's/.*MP_DEBUG.*/#define MP_DEBUG 1/' config.h) && \
make version.h && \
$HOST_CC -O4 -Iloader -I. codec-cfg.c mp_msg.c -o codec-cfg -DCODECS2HTML && \
make && \
$STRIP mplayer libdha/libdha.so vidix/drivers/*.so && \
cd "$CWD" && \
exit 0

cd "$CWD"
exit 1
