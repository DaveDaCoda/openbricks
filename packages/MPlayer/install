#!/bin/sh

. config/options

$SCRIPTS/install lirc $2 || exit 1
$SCRIPTS/install autoplay $2 || exit 1
$SCRIPTS/unpack theme-$THEME || exit 1

mkdir -p $INSTALL/etc/mplayer
mkdir -p $INSTALL/usr/bin
mkdir -p $INSTALL/usr/lib/mplayer/vidix
mkdir -p $INSTALL/usr/share/mplayer/font

cp $BUILD/MPlayer*/mplayer $INSTALL/usr/bin
cp $BUILD/MPlayer*/libdha/*.so.1.0 $INSTALL/usr/lib
cp $BUILD/MPlayer*/vidix/drivers/*.so $INSTALL/usr/lib/mplayer/vidix
rm $INSTALL/usr/lib/mplayer/vidix/mga_crtc2_vid.so
rm $INSTALL/usr/lib/mplayer/vidix/sis_vid.so
cp $PACKAGES/MPlayer/mplayer.conf $INSTALL/etc/mplayer
cp $PACKAGES/MPlayer/mp_wrapper $INSTALL/usr/bin
cp $PACKAGES/MPlayer/cpd $INSTALL/usr/bin
cp $PACKAGES/MPlayer/playdir $INSTALL/usr/bin
echo $LANG > $INSTALL/etc/lang

if [ $LANG = hu ]; then
  MENU_FONT=iso-8859-2
elif [ $LANG = he ]; then
  MENU_FONT=iso-8859-8
elif [ $LANG = bg ]; then
  MENU_FONT=cp1251
elif [ $LANG = ru ]; then
  MENU_FONT=koi8r
else
  MENU_FONT=
fi
if [ -z "$SUB_FONT" ]; then
  SUB_FONT=$LANG
fi
if [ $SUB_FONT = iso-8859-2 -o $SUB_FONT = cz -o $SUB_FONT = hu -o $SUB_FONT = pl -o $SUB_FONT = ro -o $SUB_FONT = sk ]; then
  SUB_FONT=iso-8859-2
elif [ $SUB_FONT = iso-8859-8 -o $SUB_FONT = he ]; then
  SUB_FONT=iso-8859-8
elif [ $SUB_FONT = cp1251 -o $SUB_FONT = bg ]; then
  SUB_FONT=cp1251
elif [ $SUB_FONT = koi8r -o $SUB_FONT = ru ]; then
  SUB_FONT=koi8r
else
  SUB_FONT=iso-8859-1
fi
echo $SUB_FONT > $INSTALL/etc/subfont

echo "You can enable nvidia vidix driver simply by removing this file." > $INSTALL/etc/mplayer/no_nvidia_vidix
echo "Vidix should give you better performance especially with low-end hardware." >> $INSTALL/etc/mplayer/no_nvidia_vidix
echo "This feature is not very well tested. That's why it is not enabled by" >> $INSTALL/etc/mplayer/no_nvidia_vidix
echo "default. And that's also why you should help us, testing this feature" >> $INSTALL/etc/mplayer/no_nvidia_vidix
echo "and reporting your results if you own nvidia hardware." >> $INSTALL/etc/mplayer/no_nvidia_vidix

case "$2" in
  generator)
    mkdir -p $INSTALL/codecs
    mkdir -p $GENERATOR_NAME/language
    mkdir -p $GENERATOR_NAME/font
    cp $PACKAGES/MPlayer/help_*.txt $GENERATOR_NAME/language
    cp $PACKAGES/MPlayer/menu_*.conf $GENERATOR_NAME/language
    cp -r $BUILD/MPlayer*/fonts/* $GENERATOR_NAME/font/
    ;;

  installator)
    mkdir -p $INSTALL/codecs
    cp $PACKAGES/MPlayer/help_*.txt $INSTALL/usr/share/mplayer
    cp $PACKAGES/MPlayer/menu_*.conf $INSTALL/etc/mplayer
    cp -r $BUILD/MPlayer*/fonts/* $INSTALL/usr/share/mplayer/font/
    ;;

  *)
    cp $PACKAGES/MPlayer/help_$LANG.txt $INSTALL/usr/share/mplayer/
    cp $PACKAGES/MPlayer/menu_$LANG.conf $INSTALL/etc/mplayer/
    cp -r $BUILD/MPlayer*/fonts/$SUB_FONT $INSTALL/usr/share/mplayer/font/
    if [ -n "$MENU_FONT" -a "$MENU_FONT" != "$SUB_FONT" ]; then
      cp -r $BUILD/MPlayer*/fonts/$MENU_FONT $INSTALL/usr/share/mplayer/font/
    fi
    ;;
esac

cp $BUILD/MPlayer*/etc/input.conf $INSTALL/etc/mplayer
cp $BUILD/MPlayer*/etc/codecs.conf $INSTALL/etc/mplayer

cp $BUILD/theme-$THEME/*.ttf $INSTALL/usr/share/mplayer/font/font.ttf

. $BUILD/theme-$THEME/config
echo "subfont-text-scale=$FONT_SIZE" >> $INSTALL/etc/mplayer/mplayer.conf

cp $BUILD/theme-$THEME/background.avi $INSTALL/usr/share/mplayer
if [ -f $BUILD/theme-$THEME/background-audio.avi ]; then
  cp $BUILD/theme-$THEME/background-audio.avi $INSTALL/usr/share/mplayer
  BGVIDEO=/usr/share/mplayer/background-audio.avi
else
  BGVIDEO=/usr/share/mplayer/background.avi
fi
echo "bgvideo=$BGVIDEO" >> $INSTALL/etc/mplayer/mplayer.conf
