#!/bin/sh
#
# mount samba shares
#
# runlevels: geexbox, debug

if test -x /usr/bin/smbmount -a -x /usr/bin/mount.cifs -a -f /etc/network; then
  echo "### Mounting Samba shares ###"
  (
  . /etc/network
  OPT="-N"
  test -n "$SMB_USER" && OPT="-U$SMB_USER%$SMB_PWD"
  smbtree $OPT | while read mounts; do
    (
    saveifs=$IFS
    IFS='\'
    for i in $mounts; do
      IFS=$saveifs
      mkdir -p "/mnt/shares/$i"
      mount.cifs "//$i" "/mnt/shares/$i" -o ro,user=$SMB_USER,pass=$SMB_PWD >/dev/null 2>&1 || smbmount "//$i" "/mnt/shares/$i" -o ro,username=$SMB_USER,passwd=$SMB_PWD >/dev/null 2>&1 || rmdir -p "/mnt/shares/$i" >/dev/null 2>&1
      IFS='\'
    done
    IFS=$saveifs
    )&
  done
  )&
fi

exit 0
