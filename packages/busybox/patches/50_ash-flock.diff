Index: busybox-1.1.1/shell/ash.c
===================================================================
--- busybox-1.1.1.orig/shell/ash.c	2006-03-22 22:16:21.000000000 +0100
+++ busybox-1.1.1/shell/ash.c	2006-03-24 01:45:58.000000000 +0100
@@ -60,6 +60,7 @@
 #include <sys/stat.h>
 #include <sys/time.h>
 #include <sys/wait.h>
+#include <sys/file.h>
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -1234,6 +1235,7 @@
 #if JOBS
 static int fgcmd(int, char **);
 #endif
+static int flockcmd(int, char **);
 #ifdef CONFIG_ASH_GETOPTS
 static int getoptscmd(int, char **);
 #endif
@@ -1333,6 +1335,7 @@
 #if JOBS
 	{ BUILTIN_REGULAR       "fg", fgcmd },
 #endif
+	{ BUILTIN_NOSPEC        "flock", flockcmd },
 #ifdef CONFIG_ASH_GETOPTS
 	{ BUILTIN_REGULAR       "getopts", getoptscmd },
 #endif
@@ -6863,6 +6866,46 @@
 
 
 static int
+flockcmd(int argc, char **argv)
+{
+	static int fd = -1;
+	int operation = 0, c;
+
+	while ((c = nextopt("ensu")))
+		switch (c) {
+		case 'e':
+			operation |= LOCK_EX;
+			break;
+		case 'n':
+			operation |= LOCK_NB;
+			break;
+		case 's':
+			operation |= LOCK_SH;
+			break;
+		case 'u':
+			if (fd == -1 || flock(fd, LOCK_UN))
+				return 127;
+			close(fd);
+			fd = -1;
+			return 0;
+		}
+
+	c = 127;
+	if (fd == -1 && *argptr && (fd = open(*argptr, O_RDONLY | O_CREAT)) != -1)
+	{
+		if (!flock(fd, operation)) {
+			c = 0;
+		} else {
+			close(fd);
+			fd = -1;
+		}
+	}
+
+	return c;
+}
+
+
+static int
 waitcmd(int argc, char **argv)
 {
 	struct job *job;
