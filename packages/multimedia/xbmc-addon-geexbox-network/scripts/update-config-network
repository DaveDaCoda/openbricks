#!/bin/sh

DSTCFG=/etc/network
SRCCFG=$HOME/.xbmc/userdata/addon_data/geexbox.addon.network/settings.xml

# Usage: isset <variable>
isset() {
  local var="$1"

  set | grep -q "^${var}="
  return $?
}

# Usage: value=$(valueof <variable>)
valueof() {
  local tmp=
  local var="$1"

  eval tmp="\$$var"
  echo "$tmp"
}

if [ -f $SRCCFG ] ; then
  while read i ; do
    cmd=$(echo $i | \
          grep "setting " | \
          sed -e 's%.*id="\([^"]*\).*value="\([^"]*\).*%\1="\2"%')
    #[ -n "$cmd" ] && echo $cmd
    [ -n "$cmd" ] && eval $cmd
  done < $SRCCFG

  sed_cmd="sed -i $DSTCFG"
  for key in $(cat $DSTCFG | grep -v '^#' | cut -f1 -d=); do
    if isset ${key}; then
      val=$(valueof ${key})
      sed_cmd="${sed_cmd} -e 's%^${key}=.*%${key}=\"${val}\"%'"
    fi
  done
  #echo "${sed_cmd}"
  /bin/sh -c "${sed_cmd}"

  for unit in \
    "network-link.service" \
    "telnetd.socket" "sshd.socket" \
    "$(valueof NETWORK_BACKEND).service" \
    "bftpd.service" "lighttpd.service" "smbd.service" "nmbd.service"; do
      [ -e /lib/systemd/system/$unit ] && systemctl restart $unit
  done
fi
