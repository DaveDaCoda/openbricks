#! /bin/sh

. config/options
get_meta kodi

ADDON_BASE=$PKG_BUILD_DIR/project/cmake/addons
ADDON_PKG_PREFIX=$ROOT/packages/multimedia/kodi-addon-

cd $ADDON_BASE/bootstrap
cmake .
make
cd -

for d in $ADDON_BASE/addons/*.*; do
  addon=$(basename $d)

  addon_id=$(cut -f1 -d' ' "$d/$addon.txt")
  addon_url=$(cut -f2 -d' ' "$d/$addon.txt")
  addon_githash=$(cut -f3 -d' ' "$d/$addon.txt")
  if echo "$addon_githash" | grep -q "^[0-9a-fA-F]*$" ; then
    addon_gitref="2~$(echo "$addon_githash" | cut -b -7)"
  else
    addon_gitref=$addon_githash
  fi
  
  if [ ! -e ${ADDON_PKG_PREFIX}${addon_id}/meta ]; then
    echo "File ${ADDON_PKG_PREFIX}${addon_id}/meta NOT found!"
    continue
  fi
  
  if [ "$addon" != "$addon_id" ]; then
    echo "Addon name mismatch: \"${addon}\" should be \"${addon_id}\""
    continue
  fi
  
  #echo $addon_id $addon_url $addon_gitref
  
  sed \
    -i ${ADDON_PKG_PREFIX}${addon_id}/meta \
    -e "s%^ADDON_ID=.*%ADDON_ID=\"${addon_id}\"%" \
    -e "s%^PKG_URL_REV=.*%PKG_URL_REV=\"${addon_gitref}\"%" \
    -e "s%^PKG_URL=.*%PKG_URL=\"$(dirname ${addon_url})/\${ADDON_ID}.git\"%"
  
done

echo "Please check addon version numbers manually !!!"
