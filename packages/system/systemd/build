#!/bin/sh

. config/options
$SCRIPTS/uninstalldev dbus

get_meta $1
cd $PKG_BUILD_DIR

if [ ! -e ./configure ]; then
  # workaround for hosts that don't support 'ln --relative'
  # we use a wrapper script to emulate this option
  sed -i -e "s%ln --relative%ln%" configure.ac
  sed -i -e "s%\$(LN_S) --relative%${PWD}/ln-relative%" Makefile.am

  ./autogen.sh
fi

export ac_cv_func_malloc_0_nonnull=yes
export ac_cv_path_KMOD="/usr/bin/kmod"
GCC_NO_LTO=1 GCC_NO_GOLD=1 \
do_configure \
            --disable-utmp \
            --disable-gnuefi \
            --disable-timesyncd \
            --disable-resolved \
            --disable-networkd \
            --disable-libiptc \
            --disable-kdbus \
            --disable-tests \
            --disable-split-usr \
            --disable-selinux \
            --disable-ima \
            --disable-pam \
            --disable-audit \
            --disable-acl \
            --disable-libcryptsetup \
            --disable-binfmt \
            --disable-hostnamed \
            --disable-timedated \
            --disable-localed \
            --disable-logind \
            --disable-coredump \
            --disable-vconsole \
            --disable-xz \
            --disable-quotacheck \
            --disable-manpages \
            --disable-qrencode \
            --disable-microhttpd \
            --disable-bootchart \
            --without-python \
            --with-dbuspolicydir=/etc/dbus-1/system.d \
            --with-dbussessionservicedir=/usr/share/dbus-1/services \
            --with-dbussystemservicedir=/usr/share/dbus-1/system-services \
            --with-sysvinit-path= \
            --with-sysvrcnd-path= \
            --with-pamlibdir= \
            --with-rootprefix= \
            --with-rootlibdir=/lib

export MAKEFLAGS=-j1
make
make_install

SYSTEMD=.install/lib/systemd
SYSUNITS=$SYSTEMD/system

# we don't care about utmp (it's not even supported by our libc)
if [ $PKG_VERSION -lt 217 ]; then
  rm -f $SYSTEMD/systemd-update-utmp
  rm -f $SYSUNITS/systemd-update-utmp.service
  rm -f $SYSUNITS/sysinit.target.wants/systemd-update-utmp.service
  rm -f $SYSUNITS/systemd-update-utmp-runlevel.service
  rm -f $SYSUNITS/systemd-update-utmp-shutdown.service
  rm -f $SYSUNITS/shutdown.target.wants/systemd-update-utmp-shutdown.service
  rm -f $SYSUNITS/runlevel?.target.wants/systemd-update-utmp-runlevel.service
fi

# boot to multi-user.target as fallback default
ln -sf multi-user.target $SYSUNITS/default.target

# udev
if [ $PKG_VERSION -lt 209 ]; then
  systemd_libs="gudev-1.0 systemd-daemon systemd-id128 systemd-journal"
elif [ $PKG_VERSION -lt 221 ]; then
  systemd_libs="gudev-1.0 systemd"
else
  systemd_libs="systemd"
fi

# Note: These links are only valid in the toolchain tree
for i in $systemd_libs; do
  ln -sf ../../../lib/lib${i}.so.0 .install/usr/lib/lib${i}.so
done
ln -sf ../../../lib/libudev.so.1 .install/usr/lib/libudev.so

sed -i -e 's/, *GROUP=\"[^\"]*\"//g' .install/lib/udev/rules.d/*
