#!/bin/sh
#
# Load ndiswrapper
#
# runlevels: geexbox, debug

DRVDIR=/ndiswrapper
ETCDIR=/etc/ndiswrapper

basename()
{
  echo "${1##*/}"
}

dirname()
{
  echo "${1%/*}"
}

stripext()
{
  echo "${1%.*}"
}

tolower()
{
  echo "$1" | sed "y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/"
}

if [ `ls $DRVDIR | grep -c -e ".*"` -gt 0 ]; then
  echo "### Loading NdisWrapper drivers ###"

  find "$DRVDIR" -name "*.[iI][nN][fF]" | while read INF_FILE; do
    BASENAME=$(basename $INF_FILE)
    DIRNAME=$(dirname $INF_FILE)
    BASEDIR="$ETCDIR/$(tolower $(stripext $BASENAME))"
    mkdir -p "$BASEDIR"
    ln -s "$INF_FILE" "$BASEDIR/"
    find "$DIRNAME" -name "*.[sS][yY][sS]" | while read SYS_FILE; do
      ln -s "$SYS_FILE" "$BASEDIR/"
    done
    ndiswrapper_convert "$BASEDIR/$BASENAME"
  done
  modprobe ndiswrapper
fi

exit 0
