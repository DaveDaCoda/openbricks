#!/bin/sh
#
# Load ndiswrapper
#
# runlevels: geexbox, debug

DRVDIR=/ndiswrapper
ETCDIR=/etc/ndiswrapper

basename()
{
  echo $1 | sed -e "s#.*/\(.*\)#\1#" | sed -e "s#\(.*\)\..*#\1#"
}

tolower()
{
  echo $1 | sed "y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/"
}

if [ `ls $DRVDIR | grep -c -e ".*"` -gt 0 ]; then
  echo "### Loading NdisWrapper drivers ###"

  for INF_FILE in `ls $DRVDIR/*.[iI][nN][fF]`; do
    BASENAME=$(basename $(tolower $INF_FILE))
    BASEDIR="$ETCDIR/$BASENAME"
    mkdir -p $BASEDIR
    ln -s $INF_FILE $BASEDIR/
    for SYS_FILE in `ls $DRVDIR/*.[sS][yY][sS]`; do
      ln -s $SYS_FILE $BASEDIR/
    done
    ndiswrapper_convert "$BASEDIR/*.[iI][nN][fF]"
  done
  modprobe ndiswrapper
fi

exit 0
