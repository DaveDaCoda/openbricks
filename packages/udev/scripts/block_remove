#!/bin/sh

MNTLOCK=/mnt/ramfs/tmp/mntlock
DEVNAME=${DEVNAME#/mnt/ramfs}

flock -e $MNTLOCK
MNT=`sed -n "s|^$DEVNAME \(.*\)|\1|p" /mnt/ramfs/etc/fstab`
if [ -n "$MNT" ]; then
  sed -i -n "\|^$DEVNAME.*|T;p" /mnt/ramfs/etc/fstab
  flock -u
  umount "$MNT"
  while [ "$?" = 16 ]; do # umount returned EBUSY
    sleep 1
    umount "$MNT"
  done
  rmdir "$MNT"
else
  flock -u
fi
