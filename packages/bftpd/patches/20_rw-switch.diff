--- bftpd-1.3/commands.c.orig	2006-04-11 22:42:34.000000000 +0800
+++ bftpd-1.3/commands.c	2006-04-11 22:51:46.000000000 +0800
@@ -85,6 +85,57 @@
     bftpd_statuslog(3, success, "%s", buffer);
 }
 
+static void rw_ro(char *script, char *path)
+{
+    pid_t pid;
+    sighandler_t save_quit, save_int, save_chld;
+
+    save_quit = signal(SIGQUIT, SIG_IGN);
+    save_int = signal(SIGINT, SIG_IGN);
+    save_chld = signal(SIGCHLD, SIG_DFL);
+
+    if ((pid = vfork()) < 0) {
+    	signal(SIGQUIT, save_quit);
+	signal(SIGINT, save_int);
+	signal(SIGCHLD, save_chld);
+	return;
+    }
+    if (pid == 0) {
+	char *const argv[] = { script, path, NULL };
+
+	signal(SIGQUIT, SIG_DFL);
+	signal(SIGINT, SIG_DFL);
+	signal(SIGCHLD, SIG_DFL);
+
+	execv(script, argv);
+	_exit(127);
+    }
+
+    /* Signals are not absolutly guarenteed with vfork */
+    signal(SIGQUIT, SIG_IGN);
+    signal(SIGINT, SIG_IGN);
+
+    do {
+	pid = wait4(pid, NULL, 0, NULL);
+    } while (pid == -1 && errno == EINTR);
+
+    signal(SIGQUIT, save_quit);
+    signal(SIGINT, save_int);
+    signal(SIGCHLD, save_chld);
+
+    return;
+}
+
+static inline void rw(char *path)
+{
+    rw_ro("/usr/bin/rw", path);
+}
+
+static inline void ro(char *path)
+{
+    rw_ro("/usr/bin/ro", path);
+}
+
 void new_umask()
 {
     int um;
@@ -484,6 +535,7 @@
     struct timeval tv;
     char *p, *pp;
 	char *mapped = bftpd_cwd_mappath(filename);
+    rw(mapped);
 
     int my_buffer_size;    /* total transfer buffer size divided by number of clients */
     int num_clients;       /* number of clients connected to the server */
@@ -532,12 +584,13 @@
         if (! attempt_gzip)
         {        
 	  fd = open(mapped, flags, 00666);
-	  if (mapped)
-	 	free(mapped);
 	  if (fd == -1) {
 		bftpd_log("Error: '%s' while trying to store file '%s'.\n",
 				  strerror(errno), filename);
 		control_printf(SL_FAILURE, "553 Error: %s.", strerror(errno));
+        close(fd);
+        ro(mapped);
+        free(mapped);
 		return;
           }
 	}
@@ -560,7 +613,12 @@
 
 	bftpd_log("Client is storing file '%s'.\n", filename);
 	if (dataconn())
+    {
+        close(fd);
+        ro(mapped);
+        free(mapped);
 		return;
+    }
 
     /* Figure out how big the transfer buffer should be.
        This will be the total size divided by the number of clients connected.
@@ -597,6 +655,7 @@
         if (!select(max, &rfds, NULL, NULL, &tv)) {
             close(sock);
             close(fd);
+            ro(mapped);
             control_printf(SL_FAILURE, "426 Kicked due to data transmission timeout.");
             bftpd_log("Kicked due to data transmission timeout.\n");
             /* Before we exit, let's remove our entry in the log file. -- Jesse */
@@ -607,6 +666,9 @@
             test_abort(0, fd, sock);
 			if (buffer)
 				free(buffer);
+            close(fd);
+            ro(mapped);
+            free(mapped);
             return;
         }
 
@@ -663,6 +725,8 @@
         #endif
 
 	close(sock);
+	ro(mapped);
+	free(mapped);
     alarm(control_timeout);
     offset = 0;
 	control_printf(SL_SUCCESS, "226 File transmission successful.");
@@ -1128,6 +1192,7 @@
 void command_dele(char *filename)
 {
 	char *mapped = bftpd_cwd_mappath(filename);
+	rw(mapped);
 	if (unlink(mapped)) {
 		bftpd_log("Error: '%s' while trying to delete file '%s'.\n",
 				  strerror(errno), filename);
@@ -1136,12 +1201,14 @@
 		bftpd_log("Deleted file '%s'.\n", filename);
 		control_printf(SL_SUCCESS, "200 OK");
 	}
+	ro(mapped);
 	free(mapped);
 }
 
 void command_mkd(char *dirname)
 {
 	char *mapped = bftpd_cwd_mappath(dirname);
+	rw(mapped);
 	if (mkdir(mapped, 0755)) {
 		bftpd_log("Error: '%s' while trying to create directory '%s'.\n",
 				  strerror(errno), dirname);
@@ -1150,12 +1217,14 @@
 		bftpd_log("Created directory '%s'.\n", dirname);
 		control_printf(SL_SUCCESS, "257 \"%s\" has been created.", dirname);
 	}
+	ro(mapped);
 	free(mapped);
 }
 
 void command_rmd(char *dirname)
 {
 	char *mapped = bftpd_cwd_mappath(dirname);
+	rw(mapped);
 	if (rmdir(mapped)) {
 		bftpd_log("Error: '%s' while trying to remove directory '%s'.\n",
 				  strerror(errno), dirname);
@@ -1164,6 +1233,7 @@
 		bftpd_log("Removed directory '%s'.\n", dirname);
 		control_printf(SL_SUCCESS, "250 OK");
 	}
+	ro(mapped);
 	free(mapped);
 }
 
@@ -1192,6 +1262,8 @@
 void command_rnto(char *newname)
 {
 	char *mapped = bftpd_cwd_mappath(newname);
+	rw(philename);
+	rw(mapped);
 	if (rename(philename, mapped)) {
 		bftpd_log("Error: '%s' while trying to rename '%s' to '%s'.\n",
 				  strerror(errno), philename, bftpd_cwd_mappath(newname));
@@ -1203,6 +1275,8 @@
 	}
 	free(philename);
 	free(mapped);
+	ro(mapped);
+	ro(philename);
 	philename = NULL;
 }
 
@@ -1252,6 +1326,7 @@
 		return;
 	}
 	mapped = bftpd_cwd_mappath(strdup(strchr(params, ' ') + 1));
+	rw(mapped);
 	*strchr(params, ' ') = '\0';
 	sscanf(params, "%o", &permissions);
 	if (chmod(mapped, permissions))
@@ -1261,6 +1336,7 @@
 				  permissions);
 		control_printf(SL_SUCCESS, "200 CHMOD successful.");
 	}
+	ro(mapped);
 	free(mapped);
 }
 
@@ -1291,6 +1367,7 @@
 			return;
 		}
 	mapped = bftpd_cwd_mappath(filename);
+	rw(mapped);
 	if (chown(mapped, uid, gid))
 		control_printf(SL_FAILURE, "550 Error: %s.", strerror(errno));
 	else {
@@ -1298,6 +1375,7 @@
 				  gid);
 		control_printf(SL_SUCCESS, "200 CHOWN successful.");
 	}
+	ro(mapped);
 	free(mapped);
 }
 
