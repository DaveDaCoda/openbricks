#!/bin/sh

. config/path
. $CONFIG/options

$SCRIPTS/build linux || exit 1


DPREFIX=`ls -d $ROOT/$BUILD/uClibc*`/build
KSRC=`ls -d $ROOT/$BUILD/linux-*`

sed -e "s%^KERNEL_SOURCE=.*%KERNEL_SOURCE=\"$KSRC\"%" \
    -e "s%^RUNTIME_PREFIX=.*%RUNTIME_PREFIX=\"$DPREFIX\"%" \
    -e "s%^DEVEL_PREFIX=.*%DEVEL_PREFIX=\"$DPREFIX\"%"  \
    $PACKAGES/uClibc/uClibc.conf > `ls -d $BUILD/uClibc-*`/.config

if [ "$CPU" == "C3" ]; then
  sed -i s%.*CONFIG_CYRIXIII.*%CONFIG_CYRIXIII=y% $BUILD/uClibc*/.config
  sed -i s%.*CONFIG_586.*%CONFIG_586=n% $BUILD/uClibc*/.config
fi

sed -i 's%^\(include.*\)%\1\nUCLIBC_HAS_LOCALE=%' $BUILD/uClibc*/utils/Makefile
sed -i 's%-L../lib%%' $BUILD/uClibc*/utils/Makefile
sed -i 's%TARGETS =.*%TARGETS = ldd%' $BUILD/uClibc*/utils/Makefile
sed -i 's%.*INSTALL.*ldconfig.*%%' $BUILD/uClibc*/utils/Makefile

tar xjf $SOURCES/uClibc/locale-uClibc-*.tar.bz2 -C $BUILD/uClibc*/extra/locale

yes '' | make oldconfig -C "`ls -d $BUILD/uClibc*`"
